#include <stdio.h>
#include <time.h>

int main(void) {
    const double เติมต่อวัน = 150.0, วงเงินรวม = 3000.0;
    double สิทธิ์ = 0, คืนรวม = 0, ราคารวม = 0, จ่ายรวม = 0, กระเป๋า = 0;
    int วันล่าสุด = 0, เดือนล่าสุด = 0, ปีล่าสุด = 0;

    FILE *f = fopen("state.txt", "r");
    if (f) fscanf(f, "%d %d %d %lf %lf %lf %lf %lf",
                  &วันล่าสุด, &เดือนล่าสุด, &ปีล่าสุด,
                  &สิทธิ์, &คืนรวม, &ราคารวม, &จ่ายรวม, &กระเป๋า),
           fclose(f);

    // ดึงวันที่ปัจจุบันจากระบบ
    time_t t = time(NULL);
    struct tm *now = localtime(&t);
    int d = now->tm_mday, m = now->tm_mon + 1, y = now->tm_year + 1900;

    // ถ้ามีไฟล์เก่า → เติมสิทธิ์ตามจำนวนวันต่าง
    if (ปีล่าสุด) {
        struct tm a = {.tm_year=ปีล่าสุด-1900, .tm_mon=เดือนล่าสุด-1, .tm_mday=วันล่าสุด};
        double diff = difftime(mktime(now), mktime(&a)) / (60*60*24);
        if (diff > 0) สิทธิ์ += diff * เติมต่อวัน;
    } else {
        // ครั้งแรก
        สิทธิ์ = เติมต่อวัน;
        printf("เริ่มโครงการวันนี้ %02d/%02d/%d\n", d, m, y);
    }

    printf("(วันนี้ %02d/%02d/%d) สิทธิ์สะสม %.2f บาท\n", d, m, y, สิทธิ์);

    // ===== ใส่บิล =====
    int n; printf("จำนวนบิลวันนี้: "); scanf("%d", &n);
    for (int i = 1; i <= n; i++) {
        double ราคา; int ร่วม;
        printf("\nชื่อสินค้า %d: ", i);
        char สินค้า[50]; scanf(" %49[^\n]", สินค้า);
        printf("ราคา: "); scanf("%lf", &ราคา);
        printf("ร่วมโครงการ? (1=ใช่ 0=ไม่): "); scanf("%d", &ร่วม);

        double ต้องคืน = ร่วม ? 0.5*ราคา : 0;
        if (ต้องคืน > สิทธิ์) ต้องคืน = สิทธิ์;
        if (ต้องคืน + คืนรวม > วงเงินรวม) ต้องคืน = วงเงินรวม - คืนรวม;
        double จ่ายจริง = ราคา - ต้องคืน;

        สิทธิ์ -= ต้องคืน;
        คืนรวม += ต้องคืน;
        ราคารวม += ราคา;
        จ่ายรวม += จ่ายจริง;
        กระเป๋า += ต้องคืน;

        printf("สินค้า: %s | ราคา %.2f | คืน %.2f | จ่ายจริง %.2f | สิทธิ์เหลือ %.2f\n",
               สินค้า, ราคา, ต้องคืน, จ่ายจริง, สิทธิ์);
    }

    // ===== สรุป & บันทึก =====
    printf("\nรวมราคาทั้งหมด %.2f | คืน %.2f | จ่ายจริง %.2f | กระเป๋า %.2f | สิทธิ์เหลือ %.2f\n",
           ราคารวม, คืนรวม, จ่ายรวม, กระเป๋า, สิทธิ์);

    f = fopen("state.txt", "w");
    fprintf(f, "%d %d %d %.2f %.2f %.2f %.2f %.2f",
            d, m, y, สิทธิ์, คืนรวม, ราคารวม, จ่ายรวม, กระเป๋า);
    fclose(f);

    return 0;
}
